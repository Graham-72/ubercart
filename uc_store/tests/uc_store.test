<?php

/**
 * @file
 * Test functionality provided by uc_store.
 */

/**
 * Test the country import and update functions.
 */
class UbercartCountriesTestCase extends DrupalWebTestCase {

  function getInfo() {
    return array(
      'name' => t('Country functionality'),
      'description' => t('Import, edit, and remove countries and their settings.'),
      'group' => t('Ubercart'),
    );
  }

  function setUp() {
    parent::setUp('uc_store');

    $admin_user = $this->drupalCreateUser(array('administer store'));
    $this->drupalLogin($admin_user);
  }

  /**
   *
   */
  function testCountryImport() {

// Then need to check to see if this page is accessible to anonymous user,
// try to delete etc through GET.

// Then identify CIFs that have multiple versions and test update.

// Then import all CIF, delete all CIF except USA and CAN

// Need to test address formats

// Need to test countries API

  }

  /**
   * Test import/enable/disable/remove of Country information files.
   */
  function testCountry() {
    // Test TWO random countries with the full suite
    $files = _uc_country_import_list();
    foreach (array_rand($files, 2) as $index) {
      $import_file = $files[$index]['file'];
      $country_name = uc_country_get_by_id($index);
      $country_code = 'BEL';

      $this->drupalGet('admin/store/settings/countries/edit');
      $this->assertRaw('<option value="' . $import_file . '">' . $import_file . '</option>', t('Ensure country file @file is not imported yet.', array('@file' => $import_file)));

      $edit = array(
        'import_file[]' => array($import_file => $import_file),
      );
      $this->drupalPost('admin/store/settings/countries/edit', $edit, t('Import'));
      $this->assertText(t('Country file @file imported.', array('@file' => $import_file)), t('Country was imported successfully.'));
      $this->assertText($country_code, t('Country appears in the imported countries table.'));
      $this->assertNoRaw('<option value="' . $import_file . '">' . $import_file . '</option>', t('Country does not appear in list of files to be imported.'));

      // Have to pick the right one here!
      $this->clickLink(t('disable'));
      $this->assertText(t('@name disabled.', array('@name' => $country_name)), t('Country was disabled.'));

      $this->clickLink(t('enable'));
      $this->assertText(t('@name enabled.', array('@name' => $country_name)), t('Country was enabled.'));

      $this->clickLink(t('remove'));
      $this->assertText(t('Are you sure you want to remove @name from the system?', array('@name' => $country_name)), t('Confirm form is displayed.'));

      $this->drupalPost('admin/store/settings/countries/' . $index . '/remove', array(), t('Remove'));
      $this->assertText(t('@name removed.', array('@name' => $country_name)), t('Country removed.'));
      $this->assertRaw('<option value="' . $import_file . '">' . $import_file . '</option>', t('Ensure country file is not imported yet.'));
      $this->assertNoText($country_code, t('Country does not appear in imported countries table.'));
    }
  }

}
